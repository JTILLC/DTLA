<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Service and Invoice Data for Joshua Todd Industries</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" onerror="console.error('Failed to load DataTables CSS')">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" onerror="console.error('Failed to load Bootstrap CSS')">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css" onerror="console.error('Failed to load Datepicker CSS')">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"><\/script>');</script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>window.jQuery.fn.DataTable || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"><\/script>');</script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>window.bootstrap || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js"><\/script>');</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>window.Chart || document.write('<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.min.js"><\/script>');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>window.jspdf || document.write('<script src="https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js"><\/script>');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script>window.jspdf && !window.jspdf.autoTable || document.write('<script src="https://unpkg.com/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"><\/script>');</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <script>window.jQuery.fn.datepicker || document.write('<script src="https://unpkg.com/bootstrap-datepicker@1.9.0/dist/js/bootstrap-datepicker.min.js"><\/script>');</script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .summary { margin-bottom: 20px; }
        .summary div { font-weight: bold; }
        #monthlyChart, #comparisonChart, #monthlyComparisonChart { max-width: 800px; margin: 20px 0; }
        table.dataTable tbody tr.selected { background-color: #b0bed9; }
        .actions { margin-bottom: 20px; }
        .paid-checkbox { cursor: pointer; }
        .year-nav { margin-bottom: 20px; }
        #comparisonPage, #yearPage { display: none; }
        #comparisonPage.active, #yearPage.active { display: block; }
        .dataTables_scrollBody { max-height: 400px; overflow-y: auto; }
        .datepicker { z-index: 1050 !important; }
    </style>
</head>
<body>
    <h1>Service and Invoice Data for Joshua Todd Industries</h1>
    
    <div class="year-nav">
        <label for="yearSelect">Select Year: </label>
        <select id="yearSelect" class="form-select d-inline-block w-auto"></select>
        <button class="btn btn-success ms-2" onclick="window.addNewYear()">Add New Year</button>
    </div>
    
    <div id="yearPage">
        <div id="summary" class="summary">
            <div>Quotes This Year: $0.00</div>
            <div>Gross Total Income: $0.00</div>
            <div>Paid Total Income: $0.00</div>
            <div>Unpaid Total Income: $0.00</div>
        </div>
        
        <div class="actions">
            <button class="btn btn-primary" onclick="window.addNew()">Add New</button>
            <button class="btn btn-secondary" id="editSelectedBtn" onclick="window.editSelected()">Edit Selected</button>
            <button class="btn btn-danger" onclick="window.deleteSelected()">Delete Selected</button>
            <button class="btn btn-info" onclick="window.exportJson()">Export JSON (Current Year)</button>
            <button class="btn btn-info ms-1" onclick="window.exportAllYearsJson()">Export All Years JSON</button>
            <button class="btn btn-info ms-1" onclick="document.getElementById('importFile').click()">Import JSON</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="window.importJson(event)">
            <button class="btn btn-info ms-1" onclick="window.saveToCloud()">Save to Cloud</button>
            <button class="btn btn-info ms-1" onclick="window.loadFromCloud()">Load from Cloud</button>
            <button class="btn btn-info ms-1" onclick="window.exportPdf()">Export PDF</button>
            <button class="btn btn-warning ms-1" onclick="window.confirmClearStorage()">Clear Local Storage</button>
            <button class="btn btn-warning ms-1" onclick="window.confirmClearCurrentYear()">Clear Current Year</button>
        </div>
        
        <h2>Jobs Table</h2>
        <table id="jobsTable" class="display" style="width:100%">
            <thead>
                <tr>
                    <th>Date Range</th>
                    <th>Customer</th>
                    <th>City</th>
                    <th>State</th>
                    <th>Quote</th>
                    <th>Actual</th>
                    <th>SR#</th>
                    <th>Terms</th>
                    <th>Exp Paid</th>
                    <th>Paid?</th>
                    <th>Invoice Date</th>
                </tr>
            </thead>
        </table>
        
        <h2>Monthly Income Chart</h2>
        <canvas id="monthlyChart" width="800" height="400"></canvas>
    </div>
    
    <div id="comparisonPage">
        <h2>Yearly Comparison</h2>
        <table id="comparisonTable" class="table table-bordered">
            <thead>
                <tr>
                    <th>Year</th>
                    <th>Quotes</th>
                    <th>Gross Total Income</th>
                    <th>Paid Total Income</th>
                    <th>Unpaid Total Income</th>
                </tr>
            </thead>
            <tbody id="comparisonTableBody"></tbody>
        </table>
        <h2>Yearly Comparison Chart</h2>
        <canvas id="comparisonChart" width="800" height="400"></canvas>
        <h2>Monthly Comparison Across Years</h2>
        <canvas id="monthlyComparisonChart" width="800" height="400"></canvas>
    </div>
    
    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="window.resetEditState()"></button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <div class="mb-3"><label>Date Range</label><input type="text" class="form-control" id="dateRange"></div>
                        <div class="mb-3"><label>Customer</label><input type="text" class="form-control" id="customer"></div>
                        <div class="mb-3"><label>City</label><input type="text" class="form-control" id="city"></div>
                        <div class="mb-3"><label>State</label><input type="text" class="form-control" id="state"></div>
                        <div class="mb-3"><label>Quote</label><input type="number" step="0.01" class="form-control" id="quote"></div>
                        <div class="mb-3"><label>Actual</label><input type="number" step="0.01" class="form-control" id="actual"></div>
                        <div class="mb-3"><label>SR#</label><input type="text" class="form-control" id="sr"></div>
                        <div class="mb-3"><label>Terms</label><input type="text" class="form-control" id="terms"></div>
                        <div class="mb-3"><label>Exp Paid</label><input type="text" class="form-control" id="expPaid"></div>
                        <div class="mb-3"><label>Invoice Date</label><input type="text" class="form-control" id="invoiceDate" placeholder="YYYY-MM-DD"></div>
                        <div class="mb-3"><label>Paid?</label><input type="checkbox" id="paid"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="window.resetEditState()">Close</button>
                    <button type="button" class="btn btn-primary" id="saveJobBtn" onclick="window.saveJob()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Year Modal -->
    <div class="modal fade" id="addYearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Year</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newYear">Year</label>
                        <input type="number" class="form-control" id="newYear" min="1900" max="2100">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="window.saveNewYear()">Save</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clear Storage Confirmation Modal -->
    <div class="modal fade" id="clearStorageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Clear Local Storage</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to clear all data? This cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="window.clearStorage()">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Clear Current Year Confirmation Modal -->
    <div class="modal fade" id="clearCurrentYearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Clear Current Year</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to clear all data for <span id="clearYearText"></span>? This cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="window.clearCurrentYear()">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Import Year Modal -->
    <div class="modal fade" id="importYearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Year for Import</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="importYear">Year</label>
                        <input type="number" class="form-control" id="importYear" min="1900" max="2100" placeholder="e.g., 2024">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmImportYear" onclick="window.confirmImportJson()">Import</button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
            return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
            if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
                try {
                    var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                    var firstSheetName = workbook.SheetNames[0];
                    var worksheet = workbook.Sheets[firstSheetName];
                    var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                    var filteredData = jsonData.filter(row => row.some(filledCell));
                    var headerRowIndex = filteredData.findIndex((row, index) =>
                        row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                    );
                    if (headerRowIndex === -1 || headerRowIndex > 25) {
                        headerRowIndex = 0;
                    }
                    var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
                    csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                    return csv;
                } catch (e) {
                    console.error(e);
                    return "";
                }
            }
            return gk_fileData[filename] || "";
        }
    </script>

    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCnBuhq5hT62J3_O5kQRsTQucNDyYxMnsM",
            authDomain: "jobs-data-17ee4.firebaseapp.com",
            projectId: "jobs-data-17ee4",
            storageBucket: "jobs-data-17ee4.firebasestorage.app",
            messagingSenderId: "243005500287",
            appId: "1:243005500287:web:439852c7875e42cc14484a",
            measurementId: "G-3JJSP5QEFM"
        };

        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

        // Initialize Firebase
        let app, storage;
        try {
            app = initializeApp(firebaseConfig);
            storage = getStorage(app);
            console.log('Firebase initialized successfully');
        } catch (e) {
            console.error('Error initializing Firebase:', e);
            alert('Failed to initialize Firebase. Check console for details.');
        }

        // Global variables
        let data = {};
        let table = null;
        let chart = null;
        let monthlyComparisonChart = null;
        let selectedRow = null;
        let currentYear = '2025';
        let importFileData = null;

        function loadFromStorage() {
            try {
                const savedYears = localStorage.getItem('years');
                const years = savedYears ? JSON.parse(savedYears) : ['2025'];
                years.forEach(year => {
                    const savedData = localStorage.getItem(`data-${year}`);
                    if (savedData) {
                        try {
                            const parsedData = JSON.parse(savedData);
                            if (Array.isArray(parsedData)) {
                                data[year] = parsedData;
                            } else {
                                console.warn(`Invalid data for year ${year}, resetting to empty array`);
                                data[year] = [];
                            }
                        } catch (e) {
                            console.error(`Error parsing data for ${year}:`, e);
                            data[year] = [];
                        }
                    } else {
                        data[year] = [];
                    }
                });
                console.log('Loaded data from storage:', data);
                return years;
            } catch (e) {
                console.error('Error loading from storage:', e);
                localStorage.removeItem('years');
                return ['2025'];
            }
        }

        function saveToStorage() {
            try {
                localStorage.setItem('years', JSON.stringify(Object.keys(data)));
                Object.keys(data).forEach(year => {
                    localStorage.setItem(`data-${year}`, JSON.stringify(data[year]));
                });
                console.log('Saved data to storage:', data);
            } catch (e) {
                console.error('Error saving to storage:', e);
            }
        }

        function updateYearSelect() {
            try {
                const yearSelect = document.getElementById('yearSelect');
                const years = Object.keys(data).sort();
                yearSelect.innerHTML = years.map(year => `<option value="${year}" ${year === currentYear ? 'selected' : ''}>${year}</option>`).join('');
                yearSelect.innerHTML += `<option value="comparison">Comparison</option>`;
                console.log('Year select updated with years:', years);
            } catch (e) {
                console.error('Error updating year select:', e);
            }
        }

        function updateSummary() {
            try {
                const jobs = data[currentYear] || [];
                const quotesTotal = jobs.reduce((sum, j) => sum + (parseFloat(j.quote) || 0), 0).toFixed(2);
                const gross = jobs.reduce((sum, j) => sum + (parseFloat(j.actual) || 0), 0).toFixed(2);
                const paidTotal = jobs.reduce((sum, j) => j.paid ? sum + (parseFloat(j.actual) || 0) : sum, 0).toFixed(2);
                const unpaid = (parseFloat(gross) - parseFloat(paidTotal)).toFixed(2);
                document.getElementById('summary').innerHTML = `
                    <div>Quotes This Year: $${quotesTotal}</div>
                    <div>Gross Total Income: $${gross}</div>
                    <div>Paid Total Income: $${paidTotal}</div>
                    <div>Unpaid Total Income: $${unpaid}</div>
                `;
                console.log(`Summary updated for ${currentYear}: Quotes=$${quotesTotal}, Gross=$${gross}, Paid=$${paidTotal}, Unpaid=$${unpaid}`);
            } catch (e) {
                console.error('Error updating summary:', e);
            }
        }

        function computeMonthlyData(jobs) {
            try {
                const monthly = { January: 0, February: 0, March: 0, April: 0, May: 0, June: 0, July: 0, August: 0, September: 0, October: 0, November: 0, December: 0 };
                jobs.forEach(job => {
                    if (!job.dateRange) return;
                    const match = job.dateRange.match(/^(\d{1,2})/);
                    if (match) {
                        const month = parseInt(match[1]);
                        const monthName = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month - 1];
                        monthly[monthName] += parseFloat(job.actual) || 0;
                    }
                });
                return monthly;
            } catch (e) {
                console.error('Error computing monthly data:', e);
                return { January: 0, February: 0, March: 0, April: 0, May: 0, June: 0, July: 0, August: 0, September: 0, October: 0, November: 0, December: 0 };
            }
        }

        function computeComparisonData() {
            try {
                const comparisonData = [];
                Object.keys(data).forEach(year => {
                    const jobs = data[year] || [];
                    const quotesTotal = jobs.reduce((sum, j) => sum + (parseFloat(j.quote) || 0), 0).toFixed(2);
                    const gross = jobs.reduce((sum, j) => sum + (parseFloat(j.actual) || 0), 0).toFixed(2);
                    const paidTotal = jobs.reduce((sum, j) => j.paid ? sum + (parseFloat(j.actual) || 0) : sum, 0).toFixed(2);
                    const unpaid = (parseFloat(gross) - parseFloat(paidTotal)).toFixed(2);
                    comparisonData.push({ year, quotesTotal, gross, paidTotal, unpaid });
                });
                return comparisonData.sort((a, b) => a.year - b.year);
            } catch (e) {
                console.error('Error computing comparison data:', e);
                return [];
            }
        }

        function computeAllMonthlyData() {
            try {
                const monthlyTotals = { January: {}, February: {}, March: {}, April: {}, May: {}, June: {}, July: {}, August: {}, September: {}, October: {}, November: {}, December: {} };
                const months = Object.keys(monthlyTotals);
                Object.keys(data).forEach(year => {
                    const jobs = data[year] || [];
                    const monthly = computeMonthlyData(jobs);
                    months.forEach(month => {
                        monthlyTotals[month][year] = monthly[month] || 0;
                    });
                });
                return { monthlyTotals, months };
            } catch (e) {
                console.error('Error computing all monthly data:', e);
                return { monthlyTotals: {}, months: [] };
            }
        }

        function calculateExpPaid(invoiceDate, terms) {
            try {
                if (!invoiceDate || !terms) return '';
                const date = new Date(invoiceDate);
                if (isNaN(date)) return '';
                const termsMatch = terms.match(/(\d+)/);
                const termsNum = termsMatch ? parseInt(termsMatch[0]) : 0;
                if (termsNum === 0) return invoiceDate;
                date.setDate(date.getDate() + termsNum);
                return date.toISOString().split('T')[0];
            } catch (e) {
                console.error('Error calculating exp paid:', e);
                return '';
            }
        }

        function cleanData() {
            try {
                Object.keys(data).forEach(year => {
                    if (!Array.isArray(data[year])) {
                        console.warn(`Invalid data for year ${year}, resetting to empty array`);
                        data[year] = [];
                    }
                });
                saveToStorage();
                console.log('Data cleaned:', data);
            } catch (e) {
                console.error('Error cleaning data:', e);
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        window.saveToCloud = async () => {
            try {
                const years = Object.keys(data);
                for (const year of years) {
                    const jobsJson = JSON.stringify(data[year] || [], null, 2);
                    const storageRef = ref(storage, `jobs-${year}.json`);
                    await uploadString(storageRef, jobsJson, 'raw', { contentType: 'application/json' });
                    console.log(`Saved jobs for ${year} to cloud`);
                }
                alert('All years saved to cloud successfully!');
            } catch (e) {
                console.error('Error saving to cloud:', e);
                alert(`Failed to save to cloud: ${e.message}`);
            }
        };

        window.loadFromCloud = async (retries = 2) => {
            try {
                const years = Object.keys(data).length > 0 ? Object.keys(data) : ['2022', '2023', '2024', '2025'];
                const newData = {};
                for (const year of years) {
                    const storageRef = ref(storage, `jobs-${year}.json`);
                    try {
                        const url = await getDownloadURL(storageRef);
                        const response = await fetch(url);
                        if (!response.ok) throw new Error(`Firebase Storage: Object jobs-${year}.json does not exist`);
                        const responseText = await response.text();
                        let jobsData;
                        try {
                            jobsData = JSON.parse(responseText);
                        } catch (parseError) {
                            throw new Error(`Invalid JSON format for ${year}: ${parseError.message}`);
                        }
                        if (!Array.isArray(jobsData)) throw new Error(`Invalid data format for ${year}`);
                        newData[year] = jobsData;
                        console.log(`Loaded jobs for ${year} from cloud`);
                    } catch (e) {
                        if (e.message.includes('does not exist')) {
                            console.warn(`No data for ${year} in cloud:`, e);
                            newData[year] = data[year] || []; // Keep local data if cloud file is missing
                        } else {
                            throw e; // Rethrow other errors for retry logic
                        }
                    }
                }
                data = newData;
                saveToStorage();
                updateYearSelect();
                if (currentYear === 'comparison') {
                    updateComparisonPage();
                } else {
                    updateYearPage();
                }
                alert('All available years loaded from cloud successfully!');
            } catch (e) {
                if (e.message.includes('Failed to fetch') && window.location.protocol === 'file:') {
                    alert(`CORS error: Cannot load from cloud when running from a local file (file://). Please run the app on a local server (e.g., http://localhost) or host it online. See console for details.`);
                    console.error('CORS error: Run the app on a local server (e.g., http-server or Python server) or host online to enable cloud access.');
                } else if (retries > 0) {
                    console.warn(`Retrying load from cloud (${retries} attempts left)...`);
                    setTimeout(() => window.loadFromCloud(retries - 1), 1000);
                } else {
                    console.error('Error loading from cloud:', e);
                    alert(`Failed to load from cloud: ${e.message}`);
                }
            }
        };

        window.addNew = () => {
            try {
                window.resetEditState();
                $('#editModal').modal('show');
                console.log('Opened add new job modal');
            } catch (e) {
                console.error('Error opening add new modal:', e);
                alert('Failed to open add new modal. Check console for details.');
            }
        };

        window.editSelected = () => {
            try {
                if (!selectedRow) {
                    alert('Please select a row first');
                    return;
                }
                const rowData = table.row(selectedRow).data();
                document.getElementById('dateRange').value = rowData.dateRange || '';
                document.getElementById('customer').value = rowData.customer || '';
                document.getElementById('city').value = rowData.city || '';
                document.getElementById('state').value = rowData.state || '';
                document.getElementById('quote').value = rowData.quote || '';
                document.getElementById('actual').value = rowData.actual || '';
                document.getElementById('sr').value = rowData.sr || '';
                document.getElementById('terms').value = rowData.terms || '';
                document.getElementById('expPaid').value = rowData.expPaid || '';
                document.getElementById('invoiceDate').value = rowData.invoiceDate || '';
                document.getElementById('paid').checked = rowData.paid || false;
                $('#editModal').modal('show');
                console.log('Opened edit modal for job:', rowData);
            } catch (e) {
                console.error('Error opening edit modal:', e);
                alert('Failed to open edit modal. Check console for details.');
            }
        };

        window.saveJob = () => {
            try {
                const newJob = {
                    dateRange: document.getElementById('dateRange').value,
                    customer: document.getElementById('customer').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value,
                    quote: parseFloat(document.getElementById('quote').value) || '',
                    actual: parseFloat(document.getElementById('actual').value) || '',
                    sr: document.getElementById('sr').value,
                    terms: document.getElementById('terms').value,
                    expPaid: document.getElementById('expPaid').value,
                    paid: document.getElementById('paid').checked,
                    invoiceDate: document.getElementById('invoiceDate').value
                };
                if (!data[currentYear]) data[currentYear] = [];
                if (selectedRow) {
                    const index = table.row(selectedRow).index();
                    data[currentYear][index] = newJob;
                } else {
                    data[currentYear].push(newJob);
                }
                $('#editModal').modal('hide');
                saveToStorage();
                updateYearPage();
                console.log('Saved job:', newJob);
            } catch (e) {
                console.error('Error saving job:', e);
                alert('Failed to save job. Check console for details.');
            }
        };

        window.deleteSelected = () => {
            try {
                if (!selectedRow) {
                    alert('Please select a row first');
                    return;
                }
                const index = table.row(selectedRow).index();
                data[currentYear].splice(index, 1);
                saveToStorage();
                updateYearPage();
                console.log(`Deleted job at index ${index} for ${currentYear}`);
            } catch (e) {
                console.error('Error deleting job:', e);
                alert('Failed to delete job. Check console for details.');
            }
        };

        window.importJson = (event) => {
            try {
                importFileData = event.target.files[0];
                if (!importFileData) return;
                $('#importYearModal').modal('show');
                console.log('Opened import year modal');
            } catch (e) {
                console.error('Error initiating JSON import:', e);
                alert('Failed to initiate JSON import. Check console for details.');
            }
        };

        window.confirmImportJson = () => {
            try {
                const importYear = document.getElementById('importYear').value;
                if (!importYear || isNaN(importYear) || importYear < 1900 || importYear > 2100) {
                    alert('Please enter a valid year (1900-2100)');
                    return;
                }
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const jsonData = JSON.parse(e.target.result);
                        if (!Array.isArray(jsonData)) throw new Error('Invalid JSON format');
                        data[importYear] = jsonData;
                        saveToStorage();
                        updateYearSelect();
                        document.getElementById('yearSelect').value = importYear;
                        currentYear = importYear;
                        updateYearPage();
                        $('#importYearModal').modal('hide');
                        alert(`Imported data for ${importYear} successfully!`);
                        console.log(`Imported JSON for ${importYear}:`, jsonData);
                    } catch (err) {
                        console.error('Error parsing JSON file:', err);
                        alert(`Invalid JSON file: ${err.message}`);
                    }
                };
                reader.onerror = () => {
                    console.error('Error reading JSON file');
                    alert('Failed to read JSON file');
                };
                reader.readAsText(importFileData);
            } catch (e) {
                console.error('Error confirming JSON import:', e);
                alert('Failed to import JSON. Check console for details.');
            }
        };

        window.exportJson = () => {
            try {
                const blob = new Blob([JSON.stringify(data[currentYear] || [], null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `jobs-${currentYear}.json`;
                a.click();
                URL.revokeObjectURL(url);
                console.log(`Exported JSON for ${currentYear}`);
            } catch (e) {
                console.error('Error exporting JSON:', e);
                alert('Failed to export JSON. Check console for details.');
            }
        };

        window.exportAllYearsJson = () => {
            try {
                const allData = {};
                Object.keys(data).forEach(year => {
                    allData[year] = data[year] || [];
                });
                const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'jobs-all-years.json';
                a.click();
                URL.revokeObjectURL(url);
                console.log('Exported all years JSON');
            } catch (e) {
                console.error('Error exporting all years JSON:', e);
                alert('Failed to export all years JSON. Check console for details.');
            }
        };

        window.exportPdf = () => {
            try {
                const { jsPDF } = window.jspdf || {};
                if (!jsPDF) throw new Error('jsPDF not loaded');
                const doc = new jsPDF();
                doc.autoTable({
                    head: [['Date Range', 'Customer', 'City', 'State', 'Quote', 'Actual', 'SR#', 'Terms', 'Exp Paid', 'Paid?', 'Invoice Date']],
                    body: (data[currentYear] || []).map(j => [
                        j.dateRange, j.customer, j.city, j.state, 
                        j.quote ? `$${parseFloat(j.quote).toFixed(2)}` : '', 
                        j.actual ? `$${parseFloat(j.actual).toFixed(2)}` : '', 
                        j.sr, j.terms, j.expPaid, j.paid ? 'true' : 'false', j.invoiceDate
                    ])
                });
                doc.save(`jobs-${currentYear}.pdf`);
                console.log(`Exported PDF for ${currentYear}`);
            } catch (e) {
                console.error('Error exporting PDF:', e);
                alert('Failed to export PDF. Check console for details.');
            }
        };

        window.addNewYear = () => {
            try {
                document.getElementById('newYear').value = '';
                $('#addYearModal').modal('show');
                console.log('Opened add new year modal');
            } catch (e) {
                console.error('Error opening add new year modal:', e);
                alert('Failed to open add new year modal. Check console for details.');
            }
        };

        window.saveNewYear = () => {
            try {
                const newYear = document.getElementById('newYear').value;
                if (!newYear || isNaN(newYear) || newYear < 1900 || newYear > 2100) {
                    alert('Please enter a valid year (1900-2100)');
                    return;
                }
                if (!data[newYear]) {
                    data[newYear] = [];
                    saveToStorage();
                    updateYearSelect();
                    document.getElementById('yearSelect').value = newYear;
                    currentYear = newYear;
                    updateYearPage();
                    $('#addYearModal').modal('hide');
                    alert(`Year ${newYear} created locally! Use "Save to Cloud" to save to Firebase.`);
                    console.log(`Created new year ${newYear} locally`);
                } else {
                    alert(`Year ${newYear} already exists`);
                }
            } catch (e) {
                console.error('Error saving new year:', e);
                alert('Failed to save new year. Check console for details.');
            }
        };

        window.confirmClearStorage = () => {
            try {
                $('#clearStorageModal').modal('show');
                console.log('Opened clear storage confirmation modal');
            } catch (e) {
                console.error('Error opening clear storage modal:', e);
                alert('Failed to open clear storage modal. Check console for details.');
            }
        };

        window.clearStorage = () => {
            try {
                localStorage.clear();
                data = { '2025': [] };
                currentYear = '2025';
                updateYearSelect();
                updateYearPage();
                $('#clearStorageModal').modal('hide');
                alert('Local storage cleared successfully!');
                console.log('Cleared local storage');
            } catch (e) {
                console.error('Error clearing storage:', e);
                alert('Failed to clear storage. Check console for details.');
            }
        };

        window.confirmClearCurrentYear = () => {
            try {
                document.getElementById('clearYearText').textContent = currentYear;
                $('#clearCurrentYearModal').modal('show');
                console.log(`Opened clear current year modal for ${currentYear}`);
            } catch (e) {
                console.error('Error opening clear current year modal:', e);
                alert('Failed to open clear current year modal. Check console for details.');
            }
        };

        window.clearCurrentYear = () => {
            try {
                data[currentYear] = [];
                saveToStorage();
                updateYearPage();
                $('#clearCurrentYearModal').modal('hide');
                alert(`Data for ${currentYear} cleared locally! Use "Save to Cloud" to update Firebase.`);
                console.log(`Cleared data for ${currentYear}`);
            } catch (e) {
                console.error('Error clearing current year:', e);
                alert('Failed to clear current year. Check console for details.');
            }
        };

        window.resetEditState = () => {
            try {
                document.getElementById('jobForm').reset();
                selectedRow = null;
                console.log('Reset edit state');
            } catch (e) {
                console.error('Error resetting edit state:', e);
            }
        };

        function updateYearPage() {
            try {
                if (table) {
                    table.destroy();
                    console.log(`Destroyed previous table for ${currentYear}`);
                }
                if (chart) {
                    chart.destroy();
                    console.log(`Destroyed previous chart for ${currentYear}`);
                }
                if (monthlyComparisonChart) {
                    monthlyComparisonChart.destroy();
                    console.log('Destroyed previous monthly comparison chart');
                }

                document.getElementById('yearPage').classList.add('active');
                document.getElementById('comparisonPage').classList.remove('active');

                const jobs = data[currentYear] || [];
                console.log(`Rendering year page for ${currentYear}, jobs:`, jobs);

                table = $('#jobsTable').DataTable({
                    data: jobs,
                    columns: [
                        { data: 'dateRange' },
                        { data: 'customer' },
                        { data: 'city' },
                        { data: 'state' },
                        { data: 'quote', render: (data) => data ? `$${parseFloat(data).toFixed(2)}` : '' },
                        { data: 'actual', render: (data) => data ? `$${parseFloat(data).toFixed(2)}` : '' },
                        { data: 'sr' },
                        { data: 'terms' },
                        { data: 'expPaid' },
                        { data: 'paid', render: (data, type, row) => `<input type="checkbox" class="paid-checkbox" ${data ? 'checked' : ''} data-row-index="${jobs.indexOf(row)}">` },
                        { data: 'invoiceDate' }
                    ],
                    pageLength: 50,
                    paging: true,
                    searching: true,
                    ordering: true,
                    info: true,
                    order: [[6, 'asc']]
                });

                selectedRow = null;
                $('#jobsTable tbody').off('click').on('click', 'tr', function (e) {
                    try {
                        if ($(e.target).is('.paid-checkbox')) return;
                        if ($(this).hasClass('selected')) {
                            $(this).removeClass('selected');
                            selectedRow = null;
                        } else {
                            table.$('tr.selected').removeClass('selected');
                            $(this).addClass('selected');
                            selectedRow = this;
                        }
                        console.log('Selected row:', selectedRow ? table.row(selectedRow).data() : null);
                    } catch (e) {
                        console.error('Error handling row selection:', e);
                        alert('Failed to handle row selection. Check console for details.');
                    }
                });

                $('#jobsTable').off('click', '.paid-checkbox').on('click', '.paid-checkbox', debounce(function (e) {
                    try {
                        e.preventDefault();
                        const rowIndex = $(this).data('row-index');
                        data[currentYear][rowIndex].paid = this.checked;
                        console.log(`Toggled paid status for job ${rowIndex} in ${currentYear}: ${this.checked}`);
                        saveToStorage();
                        updateYearPage();
                    } catch (e) {
                        console.error('Error toggling paid status:', e);
                        alert('Failed to toggle paid status. Check console for details.');
                    }
                }, 200));

                const monthlyData = computeMonthlyData(jobs);
                const ctx = document.getElementById('monthlyChart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(monthlyData),
                        datasets: [{
                            label: `Monthly Income (${currentYear})`,
                            data: Object.values(monthlyData),
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Income ($)' } }
                        }
                    }
                });
                console.log(`Monthly chart rendered for ${currentYear}`);

                updateSummary();
                saveToStorage();
            } catch (e) {
                console.error('Error updating year page:', e);
                alert('An error occurred while updating the page. Check console for details.');
            }
        }

        function updateComparisonPage() {
            try {
                if (chart) {
                    chart.destroy();
                    console.log('Destroyed previous chart');
                }
                if (monthlyComparisonChart) {
                    monthlyComparisonChart.destroy();
                    console.log('Destroyed previous monthly comparison chart');
                }

                document.getElementById('yearPage').classList.remove('active');
                document.getElementById('comparisonPage').classList.add('active');

                const comparisonData = computeComparisonData();
                const tbody = document.getElementById('comparisonTableBody');
                tbody.innerHTML = '';
                if (comparisonData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5">No data available for any year</td></tr>';
                } else {
                    comparisonData.forEach(row => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${row.year}</td>
                                <td>$${row.quotesTotal}</td>
                                <td>$${row.gross}</td>
                                <td>$${row.paidTotal}</td>
                                <td>$${row.unpaid}</td>
                            </tr>
                        `;
                    });
                }

                const ctx = document.getElementById('comparisonChart').getContext('2d');
                ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: comparisonData.map(d => d.year),
                        datasets: [
                            {
                                label: 'Quotes',
                                data: comparisonData.map(d => d.quotesTotal),
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                borderColor: 'rgba(75, 192, 192, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Gross Total Income',
                                data: comparisonData.map(d => d.gross),
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Paid Total Income',
                                data: comparisonData.map(d => d.paidTotal),
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Unpaid Total Income',
                                data: comparisonData.map(d => d.unpaid),
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Amount ($)' } }
                        }
                    }
                });

                const { monthlyTotals, months } = computeAllMonthlyData();
                const monthlyCtx = document.getElementById('monthlyComparisonChart').getContext('2d');
                monthlyCtx.clearRect(0, 0, monthlyCtx.canvas.width, monthlyCtx.canvas.height);
                monthlyComparisonChart = new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: months,
                        datasets: Object.keys(data)
                            .filter(year => data[year] && data[year].length > 0)
                            .map(year => ({
                                label: year,
                                data: months.map(m => monthlyTotals[m][year] || 0),
                                backgroundColor: `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 0.2)`,
                                borderColor: `rgba(${Math.random()*255}, ${Math.random()*255}, ${Math.random()*255}, 1)`,
                                borderWidth: 1
                            }))
                    },
                    options: {
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Income ($)' } }
                        }
                    }
                });
                console.log('Comparison page charts rendered');
            } catch (e) {
                console.error('Error updating comparison page:', e);
                alert('An error occurred while updating the comparison page. Check console for details.');
            }
        }

        // Make functions globally accessible
        window.importJson = importJson;
        window.confirmImportJson = confirmImportJson;
        window.saveToCloud = saveToCloud;
        window.loadFromCloud = loadFromCloud;
        window.addNew = addNew;
        window.editSelected = editSelected;
        window.saveJob = saveJob;
        window.deleteSelected = deleteSelected;
        window.exportJson = exportJson;
        window.exportAllYearsJson = exportAllYearsJson;
        window.exportPdf = exportPdf;
        window.addNewYear = addNewYear;
        window.saveNewYear = saveNewYear;
        window.confirmClearStorage = confirmClearStorage;
        window.clearStorage = clearStorage;
        window.confirmClearCurrentYear = confirmClearCurrentYear;
        window.clearCurrentYear = clearCurrentYear;
        window.resetEditState = resetEditState;

        // Initialize
        try {
            window.addEventListener('error', (event) => {
                console.error('Global script error:', {
                    message: event.message,
                    filename: event.filename,
                    lineno: event.lineno,
                    colno: event.colno,
                    error: event.error ? event.error.stack : 'No stack trace'
                });
                alert(`Script error: ${event.message} at ${event.filename}:${event.lineno}:${event.colno}`);
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', {
                    reason: event.reason,
                    stack: event.reason ? event.reason.stack : 'No stack trace'
                });
                alert(`Unhandled promise rejection: ${event.reason}`);
            });

            document.getElementById('yearSelect').addEventListener('change', (e) => {
                try {
                    currentYear = e.target.value;
                    if (currentYear === 'comparison') {
                        updateComparisonPage();
                    } else {
                        updateYearPage();
                    }
                } catch (e) {
                    console.error('Error handling year select change:', e);
                    alert('Failed to handle year selection. Check console for details.');
                }
            });

            $('#invoiceDate').datepicker({
                format: 'yyyy-mm-dd',
                autoclose: true,
                todayHighlight: true
            }).on('changeDate', () => {
                try {
                    const invoiceDate = document.getElementById('invoiceDate').value;
                    const terms = document.getElementById('terms').value;
                    document.getElementById('expPaid').value = calculateExpPaid(invoiceDate, terms);
                } catch (e) {
                    console.error('Error handling datepicker change:', e);
                    alert('Failed to handle datepicker change. Check console for details.');
                }
            });

            document.getElementById('terms').addEventListener('input', () => {
                try {
                    const invoiceDate = document.getElementById('invoiceDate').value;
                    const terms = document.getElementById('terms').value;
                    document.getElementById('expPaid').value = calculateExpPaid(invoiceDate, terms);
                } catch (e) {
                    console.error('Error handling terms input:', e);
                    alert('Failed to handle terms input. Check console for details.');
                }
            });

            $('#editModal').on('hidden.bs.modal', window.resetEditState);
            document.getElementById('confirmImportYear').addEventListener('click', window.confirmImportJson);

            cleanData();
            updateYearSelect();
            if (currentYear === 'comparison') {
                updateComparisonPage();
            } else {
                updateYearPage();
            }
            console.log('Application initialized successfully');
        } catch (e) {
            console.error('Initialization error:', e);
            alert('Failed to initialize application. Check console for details.');
        }
    </script>
</body>
</html>