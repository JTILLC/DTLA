<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en" data-version="1">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>JTI Jobs Tracker</title>
    <link rel="icon" type="image/png" href="/jtijobs.png" sizes="1024x1024" />
    <link rel="shortcut icon" href="/jtijobs.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/jtijobs.png" />
    <meta name="apple-mobile-web-app-title" content="JTI Jobs" />
    <link rel="manifest" href="/site.webmanifest" />
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>
    <style>
        :root { --bg:#f8f9fa; --text:#212529; --card:#fff; --border:#dee2e6; --hover:#e9ecef; }
        [data-theme="dark"] { --bg:#121212; --text:#e0e0e0; --card:#1e1e1e; --border:#333; --hover:#2d2d2d; }
        body { background:var(--bg); color:var(--text); transition:background .3s,color .3s; padding:15px; margin:0; font-family:Arial,sans-serif; }
        .card,.modal-content,.table { background:var(--card); border-color:var(--border); color:var(--text); }
        .table tbody tr:hover { background:var(--hover); }
        .dataTables_wrapper .dataTables_paginate .paginate_button { color:var(--text)!important; }
        #cloudDiffBanner { margin-bottom:15px; }
        .dark-mode-toggle { position:fixed; top:10px; right:10px; z-index:1050; font-size:12px; padding:6px 10px; }
        .summary { font-weight:bold; }
        .dataTables_wrapper .dataTables_filter input,
        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate { color:var(--text)!important; }
        .dataTables_wrapper .dataTables_filter input:focus,
        .dataTables_wrapper .dataTables_length select:focus { background:var(--card); }

        /* Mobile Responsive Styles */
        h1 { font-size: 1.5rem; margin-bottom: 15px; }
        h2 { font-size: 1.2rem; }

        .actions { display: flex; flex-wrap: wrap; gap: 8px; }
        .actions .btn { font-size: 12px; padding: 6px 10px; flex: 0 0 auto; }

        .year-nav { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .year-nav label { font-size: 14px; }
        .year-nav .btn { font-size: 12px; padding: 6px 10px; }

        #summary { font-size: 14px; }
        #summary div { margin-bottom: 4px; }

        /* DataTables mobile fixes */
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            float: none;
            text-align: left;
            margin-bottom: 10px;
        }
        .dataTables_wrapper .dataTables_filter input {
            width: 100%;
            max-width: 200px;
            margin-left: 0;
        }

        @media (max-width: 768px) {
            body { padding: 10px; }
            h1 { font-size: 1.3rem; padding-right: 80px; }
            .dark-mode-toggle { font-size: 10px; padding: 4px 8px; }

            .actions .btn {
                font-size: 11px;
                padding: 5px 8px;
            }

            #summary { padding: 12px !important; }
            #summary div { font-size: 13px; }

            .year-nav label { display: none; }
            .year-nav select { font-size: 14px; }

            #cloudDiffBanner { flex-direction: column; gap: 10px; }
            #cloudDiffBanner > div { width: 100%; display: flex; gap: 8px; }
            #cloudDiffBanner .btn { flex: 1; }

            table.dataTable { font-size: 12px; }
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate { font-size: 12px; }

            canvas { max-height: 200px !important; }
        }

        @media (max-width: 480px) {
            .actions .btn {
                flex: 1 1 calc(50% - 4px);
                text-align: center;
            }
            .year-nav .btn { font-size: 11px; }
        }

        /* Card Layout Styles */
        .jobs-cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .job-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .job-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .job-card.selected {
            border-color: #0d6efd;
            box-shadow: 0 0 0 2px rgba(13,110,253,0.25);
        }

        .job-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
        }

        .job-card-customer {
            font-weight: bold;
            font-size: 16px;
            color: var(--text);
        }

        .job-card-sr {
            font-size: 12px;
            color: #6c757d;
            background: var(--hover);
            padding: 2px 8px;
            border-radius: 4px;
        }

        .job-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
        }

        .job-card-field {
            display: flex;
            flex-direction: column;
        }

        .job-card-label {
            font-size: 11px;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .job-card-value {
            color: var(--text);
            font-weight: 500;
        }

        .job-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .job-card-paid {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .job-card-paid.is-paid {
            color: #198754;
        }

        .job-card-paid.not-paid {
            color: #dc3545;
        }

        .job-card-amounts {
            text-align: right;
        }

        .job-card-actual {
            font-size: 16px;
            font-weight: bold;
            color: #198754;
        }

        .job-card-quote {
            font-size: 11px;
            color: #6c757d;
        }

        @media (max-width: 768px) {
            .jobs-cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <button class="btn btn-outline-secondary dark-mode-toggle" id="darkModeToggle">Dark Mode Off</button>

    <h1>JTI Jobs Tracker</h1>

    <div id="cloudDiffBanner" class="alert d-flex justify-content-between align-items-center" style="display:none;">
        <span id="bannerMessage"></span>
        <div>
            <button id="bannerSaveBtn" class="btn btn-sm btn-outline-success me-2" style="display:none;" onclick="window.saveToCloud()">Save to Cloud</button>
            <button id="bannerLoadBtn" class="btn btn-sm btn-outline-primary" style="display:none;" onclick="window.loadFromCloud()">Update from Cloud</button>
        </div>
    </div>

    <div class="year-nav mb-3">
        <label for="yearSelect">Select Year: </label>
        <select id="yearSelect" class="form-select d-inline-block w-auto"></select>
        <button class="btn btn-success ms-2" onclick="window.addNewYear()">Add New Year</button>
        <button class="btn btn-info ms-2" onclick="window.checkData()">Check Data</button>
    </div>

    <div id="yearPage">
        <div id="summary" class="card p-3 mb-3">
            <div>Quotes This Year: $0.00</div>
            <div>Gross Total Income: $0.00</div>
            <div>Paid Total Income: $0.00</div>
            <div>Unpaid Total Income: $0.00</div>
        </div>

        <div class="actions mb-3">
            <button class="btn btn-primary" onclick="window.addNew()">Add New</button>
            <button class="btn btn-secondary" onclick="window.editSelected()">Edit Selected</button>
            <button class="btn btn-danger" onclick="window.deleteSelected()">Delete Selected</button>
            <button class="btn btn-info" onclick="window.exportJson()">Export JSON</button>
            <button class="btn btn-info ms-1" onclick="window.exportAllYearsJson()">Export All</button>
            <button class="btn btn-info ms-1" onclick="document.getElementById('importFile').click()">Import JSON</button>
            <input type="file" id="importFile" style="display:none" accept=".json" onchange="window.importJson(event)">
            <button class="btn btn-info ms-1" onclick="window.saveToCloud()">Save to Cloud</button>
            <button class="btn btn-info ms-1" onclick="window.loadFromCloud()">Load from Cloud</button>
            <button class="btn btn-info ms-1" onclick="window.exportPdf()">Export PDF</button>
            <button class="btn btn-warning ms-1" onclick="window.confirmClearStorage()">Clear Local</button>
            <button class="btn btn-warning ms-1" onclick="window.confirmClearCurrentYear()">Clear Year</button>
        </div>

        <h2>Jobs</h2>
        <div class="mb-3">
            <input type="text" id="jobSearch" class="form-control" placeholder="Search jobs...">
        </div>
        <div id="jobsCards" class="jobs-cards-container"></div>

        <h2 class="mt-4">Monthly Income</h2>
        <canvas id="monthlyChart" height="120"></canvas>
    </div>

    <div id="comparisonPage" style="display:none;">
        <h2>Yearly Comparison</h2>
        <table id="comparisonTable" class="table table-bordered">
            <thead class="table-light">
                <tr><th>Year</th><th>Quotes</th><th>Gross</th><th>Paid</th><th>Unpaid</th></tr>
            </thead>
            <tbody id="comparisonTableBody"></tbody>
        </table>
        <canvas id="comparisonChart" height="120" class="mt-3"></canvas>
        <h2 class="mt-4">Monthly Across Years</h2>
        <canvas id="monthlyComparisonChart" height="120"></canvas>
    </div>

    <!-- Add/Edit Modal -->
    <div class="modal fade" id="jobModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalTitle">Add Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editIndex">
                    <div class="mb-2">
                        <label>Date Range</label>
                        <input type="text" id="dateRange" class="form-control" placeholder="MM/DD - MM/DD">
                    </div>
                    <div class="mb-2">
                        <label>Customer</label>
                        <input type="text" id="customer" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>City</label>
                        <input type="text" id="city" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>State</label>
                        <input type="text" id="state" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Quote</label>
                        <input type="number" id="quote" class="form-control" step="0.01">
                    </div>
                    <div class="mb-2">
                        <label>Actual</label>
                        <input type="number" id="actual" class="form-control" step="0.01">
                    </div>
                    <div class="mb-2">
                        <label>SR#</label>
                        <input type="text" id="sr" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Terms</label>
                        <input type="text" id="terms" class="form-control">
                    </div>
                    <div class="mb-2">
                        <label>Expected Paid Date</label>
                        <input type="text" id="expPaid" class="form-control" placeholder="MM/DD/YYYY">
                    </div>
                    <div class="mb-2">
                        <label>Invoice Date</label>
                        <input type="text" id="invoiceDate" class="form-control" placeholder="MM/DD/YYYY">
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" id="paid" class="form-check-input">
                        <label class="form-check-label">Paid</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveJobBtn">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Clear Modal -->
    <div class="modal fade" id="clearModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Clear</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="clearModalBody">
                    Are you sure?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmClearBtn">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) { return cell !== '' && cell != null; }
        function loadFileData(filename) { return gk_fileData[filename] || ""; }
    </script>

    <script type="module">
        // === Firebase ===
        const firebaseConfig = {
            apiKey: "AIzaSyCnBuhq5hT62J3_O5kQRsTQucNDyYxMnsM",
            authDomain: "jobs-data-17ee4.firebaseapp.com",
            projectId: "jobs-data-17ee4",
            storageBucket: "jobs-data-17ee4.firebasestorage.app",
            messagingSenderId: "243005500287",
            appId: "1:243005500287:web:439852c7875e42cc14484a",
            measurementId: "G-3JJSP5QEFM"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js';
        import { getStorage, ref, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';

        let app, storage;
        try {
            app = initializeApp(firebaseConfig);
            storage = getStorage(app);
            console.log('Firebase initialized');
        } catch (e) { console.error(e); }

        // === Globals ===
        let data = {}, table = null, chart = null, monthlyComparisonChart = null,
            selectedRow = null, currentYear = '2025', importFileData = null;

        // === Dark Mode ===
        const toggle = document.getElementById('darkModeToggle');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const saved = localStorage.getItem('theme');
        const isDark = saved === 'dark' || (!saved && prefersDark);
        function setTheme(dark) {
            document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
            toggle.textContent = dark ? 'Light Mode' : 'Dark Mode';
            localStorage.setItem('theme', dark ? 'dark' : 'light');
            // Re-apply DataTables theme
            if (table) table.destroy();
            updateYearPage();
        }
        setTheme(isDark);
        toggle.addEventListener('click', () => setTheme(!document.documentElement.hasAttribute('data-theme') || document.documentElement.getAttribute('data-theme') !== 'dark'));

        // === Helper Functions ===
        function computeMonthlyData(jobs) {
            const m = {January:0,February:0,March:0,April:0,May:0,June:0,July:0,August:0,September:0,October:0,November:0,December:0};
            jobs.forEach(j => {
                if (!j.dateRange) return;
                const match = j.dateRange.match(/^(\d{1,2})/);
                if (match) {
                    const month = parseInt(match[1]);
                    const name = ['January','February','March','April','May','June','July','August','September','October','November','December'][month-1];
                    m[name] += parseFloat(j.actual) || 0;
                }
            });
            return m;
        }

        // === LocalStorage ===
        function loadFromStorage() {
            // Generate default years from 2022 to current + 3
            const currentYr = new Date().getFullYear();
            const defaultYears = [];
            for (let y = 2022; y <= currentYr + 3; y++) {
                defaultYears.push(y.toString());
            }
            const years = JSON.parse(localStorage.getItem('years') || JSON.stringify(defaultYears));
            years.forEach(y => { const r = localStorage.getItem(`data-${y}`); data[y] = r ? JSON.parse(r) : []; });
            return years;
        }
        function saveToStorage() {
            localStorage.setItem('years', JSON.stringify(Object.keys(data)));
            Object.keys(data).forEach(y => localStorage.setItem(`data-${y}`, JSON.stringify(data[y])));
            localStorage.setItem('localEditTime', Date.now());
        }

        // === Cloud Diff Banner ===
        async function getCloudData(year) {
            try {
                const url = await getDownloadURL(ref(storage, `jobs-${year}.json`));
                const r = await fetch(url);
                return r.ok ? await r.json() : null;
            } catch { return null; }
        }

        window.checkData = async () => {
            const banner = document.getElementById('cloudDiffBanner');
            const msg = document.getElementById('bannerMessage');
            const saveBtn = document.getElementById('bannerSaveBtn');
            const loadBtn = document.getElementById('bannerLoadBtn');
            let localNewer = false, cloudNewer = false;

            for (const y of Object.keys(data)) {
                const local = data[y];
                const cloud = await getCloudData(y);
                if (!cloud) continue;
                const lHash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(JSON.stringify(local)));
                const cHash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(JSON.stringify(cloud)));
                const lStr = Array.from(new Uint8Array(lHash)).map(b => b.toString(16).padStart(2,'0')).join('');
                const cStr = Array.from(new Uint8Array(cHash)).map(b => b.toString(16).padStart(2,'0')).join('');
                if (lStr !== cStr) {
                    const lTot = local.reduce((s,j) => s + (parseFloat(j.actual) || 0), 0);
                    const cTot = cloud.reduce((s,j) => s + (parseFloat(j.actual) || 0), 0);
                    if (lTot > cTot || local.length > cloud.length) localNewer = true;
                    else cloudNewer = true;
                }
            }

            if (localNewer || cloudNewer) {
                banner.className = localNewer ? 'alert alert-warning' : 'alert alert-info';
                msg.innerHTML = localNewer
                    ? '<strong>Data differs!</strong> Local has newer data. Save to Cloud?'
                    : '<strong>Update available!</strong> Cloud has newer data. Update from Cloud?';
                saveBtn.style.display = localNewer ? 'inline-block' : 'none';
                loadBtn.style.display = cloudNewer ? 'inline-block' : 'none';
                banner.style.display = 'flex';
            } else {
                banner.style.display = 'none';
                alert('Data is in sync!');
            }
        };

        // === Cloud Sync ===
        window.saveToCloud = async () => {
            try {
                for (const y of Object.keys(data)) {
                    await uploadString(ref(storage, `jobs-${y}.json`), JSON.stringify(data[y], null, 2), 'raw', { contentType: 'application/json' });
                }
                localStorage.removeItem('localEditTime');
                alert('Saved to cloud');
                document.getElementById('cloudDiffBanner').style.display = 'none';
            } catch (e) { alert('Save failed: ' + e.message); }
        };

        window.loadFromCloud = async () => {
            try {
                // Generate years dynamically from 2022 to current year + 3
                const defaultYears = [];
                const currentYr = new Date().getFullYear();
                for (let y = 2022; y <= currentYr + 3; y++) {
                    defaultYears.push(y.toString());
                }
                const years = Object.keys(data).length ? Object.keys(data) : defaultYears;
                const newData = {};
                for (const y of years) {
                    try {
                        const url = await getDownloadURL(ref(storage, `jobs-${y}.json`));
                        const r = await fetch(url);
                        if (r.ok) {
                            const jobs = await r.json();
                            newData[y] = Array.isArray(jobs) ? jobs : [];
                            localStorage.setItem(`data-${y}`, JSON.stringify(jobs));
                        } else { newData[y] = data[y] || []; }
                    } catch { newData[y] = data[y] || []; }
                }
                data = newData;
                saveToStorage();
                localStorage.removeItem('localEditTime');

                const loaded = Object.keys(data).sort();
                if (loaded.length && !loaded.includes(currentYear)) {
                    currentYear = loaded[0];
                }

                updateYearSelect();
                document.getElementById('yearSelect').value = currentYear;
                updateYearPage();
                document.getElementById('cloudDiffBanner').style.display = 'none';
                alert(`Loaded ${loaded.length} year(s) from cloud!`);
            } catch (e) { alert('Load failed: ' + e.message); }
        };

        // === UI Functions ===
        function updateYearSelect() {
            const sel = document.getElementById('yearSelect');
            const years = Object.keys(data).sort();
            sel.innerHTML = years.map(y => `<option value="${y}" ${y===currentYear?'selected':''}>${y}</option>`).join('');
            sel.innerHTML += `<option value="comparison">Comparison</option>`;
        }

        function updateSummary() {
            const jobs = data[currentYear] || [];
            const q = jobs.reduce((s,j) => s + (parseFloat(j.quote) || 0), 0).toFixed(2);
            const g = jobs.reduce((s,j) => s + (parseFloat(j.actual) || 0), 0).toFixed(2);
            const p = jobs.reduce((s,j) => j.paid ? s + (parseFloat(j.actual) || 0) : s, 0).toFixed(2);
            const u = (g - p).toFixed(2);
            document.getElementById('summary').innerHTML = `
                <div>Quotes This Year: $${q}</div>
                <div>Gross Total Income: $${g}</div>
                <div>Paid Total Income: $${p}</div>
                <div>Unpaid Total Income: $${u}</div>`;
        }

        function updateYearPage() {
            try {
                const scrollY = window.scrollY;

                if (chart) chart.destroy();
                if (monthlyComparisonChart) monthlyComparisonChart.destroy();

                document.getElementById('yearPage').style.display = 'block';
                document.getElementById('comparisonPage').style.display = 'none';

                const jobs = data[currentYear] || [];
                renderJobCards(jobs);

                const monthly = computeMonthlyData(jobs);
                chart = new Chart(document.getElementById('monthlyChart').getContext('2d'), {
                    type: 'bar',
                    data: { labels: Object.keys(monthly), datasets: [{ label: `Income (${currentYear})`, data: Object.values(monthly), backgroundColor: 'rgba(75,192,192,0.2)', borderColor: 'rgba(75,192,192,1)' }] },
                    options: { scales: { y: { beginAtZero: true } } }
                });

                updateSummary();
                saveToStorage();

                requestAnimationFrame(() => window.scrollTo(0, scrollY));
            } catch (e) { console.error(e); alert('Update error: ' + e.message); }
        }

        function renderJobCards(jobs, searchTerm = '') {
            const container = document.getElementById('jobsCards');

            // Filter jobs if search term provided
            let filteredJobs = jobs;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredJobs = jobs.filter(j =>
                    (j.customer || '').toLowerCase().includes(term) ||
                    (j.city || '').toLowerCase().includes(term) ||
                    (j.state || '').toLowerCase().includes(term) ||
                    (j.sr || '').toLowerCase().includes(term) ||
                    (j.dateRange || '').toLowerCase().includes(term)
                );
            }

            container.innerHTML = filteredJobs.map((job, idx) => {
                const originalIdx = jobs.indexOf(job);
                return `
                <div class="job-card" data-index="${originalIdx}">
                    <div class="job-card-header">
                        <div class="job-card-customer">${job.customer || 'No Customer'}</div>
                        ${job.sr ? `<div class="job-card-sr">SR# ${job.sr}</div>` : ''}
                    </div>
                    <div class="job-card-body">
                        <div class="job-card-field">
                            <span class="job-card-label">Date Range</span>
                            <span class="job-card-value">${job.dateRange || '-'}</span>
                        </div>
                        <div class="job-card-field">
                            <span class="job-card-label">Location</span>
                            <span class="job-card-value">${job.city || '-'}${job.state ? ', ' + job.state : ''}</span>
                        </div>
                        <div class="job-card-field">
                            <span class="job-card-label">Terms</span>
                            <span class="job-card-value">${job.terms || '-'}</span>
                        </div>
                        <div class="job-card-field">
                            <span class="job-card-label">Exp. Paid</span>
                            <span class="job-card-value">${job.expPaid || '-'}</span>
                        </div>
                        <div class="job-card-field">
                            <span class="job-card-label">Invoice Date</span>
                            <span class="job-card-value">${job.invoiceDate || '-'}</span>
                        </div>
                    </div>
                    <div class="job-card-footer">
                        <div class="job-card-paid ${job.paid ? 'is-paid' : 'not-paid'}">
                            <input type="checkbox" class="form-check-input paid-checkbox" ${job.paid ? 'checked' : ''} data-index="${originalIdx}">
                            <span>${job.paid ? 'Paid' : 'Not Paid'}</span>
                        </div>
                        <div class="job-card-amounts">
                            <div class="job-card-actual">${job.actual ? '$' + parseFloat(job.actual).toFixed(2) : '-'}</div>
                            ${job.quote ? `<div class="job-card-quote">Quote: $${parseFloat(job.quote).toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `}).join('');

            // Add click handlers for selection
            container.querySelectorAll('.job-card').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.classList.contains('paid-checkbox')) return;

                    // Deselect all others
                    container.querySelectorAll('.job-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedRow = parseInt(this.dataset.index);
                });
            });

            // Add click handlers for paid checkboxes
            container.querySelectorAll('.paid-checkbox').forEach(checkbox => {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const idx = parseInt(this.dataset.index);
                    data[currentYear][idx].paid = this.checked;
                    saveToStorage();
                    updateYearPage();
                });
            });
        }

        // Search functionality
        document.getElementById('jobSearch').addEventListener('input', function() {
            const jobs = data[currentYear] || [];
            renderJobCards(jobs, this.value);
        });

        // === Year Navigation ===
        document.getElementById('yearSelect').addEventListener('change', function() {
            const val = this.value;
            if (val === 'comparison') {
                document.getElementById('yearPage').style.display = 'none';
                document.getElementById('comparisonPage').style.display = 'block';
                updateComparison();
            } else {
                currentYear = val;
                updateYearPage();
            }
        });

        function updateComparison() {
            const years = Object.keys(data).sort();
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';
            const chartData = { labels: [], quotes: [], gross: [], paid: [], unpaid: [] };

            years.forEach(y => {
                const jobs = data[y] || [];
                const q = jobs.reduce((s,j) => s + (parseFloat(j.quote) || 0), 0);
                const g = jobs.reduce((s,j) => s + (parseFloat(j.actual) || 0), 0);
                const p = jobs.reduce((s,j) => j.paid ? s + (parseFloat(j.actual) || 0) : s, 0);
                const u = g - p;
                tbody.innerHTML += `<tr><td>${y}</td><td>$${q.toFixed(2)}</td><td>$${g.toFixed(2)}</td><td>$${p.toFixed(2)}</td><td>$${u.toFixed(2)}</td></tr>`;
                chartData.labels.push(y);
                chartData.quotes.push(q);
                chartData.gross.push(g);
                chartData.paid.push(p);
                chartData.unpaid.push(u);
            });

            if (chart) chart.destroy();
            chart = new Chart(document.getElementById('comparisonChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [
                        { label: 'Gross', data: chartData.gross, backgroundColor: 'rgba(75,192,192,0.6)' },
                        { label: 'Paid', data: chartData.paid, backgroundColor: 'rgba(54,162,235,0.6)' }
                    ]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });

            // Monthly Across Years Chart
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const monthlyData = {};

            years.forEach(y => {
                const jobs = data[y] || [];
                const monthlyIncome = computeMonthlyData(jobs);
                monthlyData[y] = months.map(m => monthlyIncome[m] || 0);
            });

            if (monthlyComparisonChart) monthlyComparisonChart.destroy();

            const colors = [
                'rgba(255, 99, 132, 0.6)',
                'rgba(54, 162, 235, 0.6)',
                'rgba(255, 206, 86, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(153, 102, 255, 0.6)',
                'rgba(255, 159, 64, 0.6)',
                'rgba(199, 199, 199, 0.6)',
                'rgba(83, 102, 255, 0.6)'
            ];

            const datasets = years.map((y, idx) => ({
                label: y,
                data: monthlyData[y],
                backgroundColor: colors[idx % colors.length],
                borderColor: colors[idx % colors.length].replace('0.6', '1'),
                borderWidth: 1
            }));

            monthlyComparisonChart = new Chart(document.getElementById('monthlyComparisonChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // === Add New Year ===
        window.addNewYear = () => {
            const year = prompt('Enter new year (e.g., 2026):');
            if (year && /^\d{4}$/.test(year)) {
                if (data[year]) {
                    alert('Year already exists!');
                    return;
                }
                data[year] = [];
                saveToStorage();
                updateYearSelect();
                currentYear = year;
                document.getElementById('yearSelect').value = year;
                updateYearPage();
            } else if (year) {
                alert('Invalid year format');
            }
        };

        // === Add New Job ===
        window.addNew = () => {
            document.getElementById('jobModalTitle').textContent = 'Add Job';
            document.getElementById('editIndex').value = '';
            document.getElementById('dateRange').value = '';
            document.getElementById('customer').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('quote').value = '';
            document.getElementById('actual').value = '';
            document.getElementById('sr').value = '';
            document.getElementById('terms').value = '';
            document.getElementById('expPaid').value = '';
            document.getElementById('invoiceDate').value = '';
            document.getElementById('paid').checked = false;
            new bootstrap.Modal(document.getElementById('jobModal')).show();
        };

        // === Edit Selected Job ===
        window.editSelected = () => {
            if (selectedRow === null || selectedRow === undefined) {
                alert('Please select a card to edit');
                return;
            }
            const job = data[currentYear][selectedRow];
            if (!job) {
                alert('Job not found');
                return;
            }

            document.getElementById('jobModalTitle').textContent = 'Edit Job';
            document.getElementById('editIndex').value = selectedRow;
            document.getElementById('dateRange').value = job.dateRange || '';
            document.getElementById('customer').value = job.customer || '';
            document.getElementById('city').value = job.city || '';
            document.getElementById('state').value = job.state || '';
            document.getElementById('quote').value = job.quote || '';
            document.getElementById('actual').value = job.actual || '';
            document.getElementById('sr').value = job.sr || '';
            document.getElementById('terms').value = job.terms || '';
            document.getElementById('expPaid').value = job.expPaid || '';
            document.getElementById('invoiceDate').value = job.invoiceDate || '';
            document.getElementById('paid').checked = job.paid || false;
            new bootstrap.Modal(document.getElementById('jobModal')).show();
        };

        // === Save Job (from modal) ===
        document.getElementById('saveJobBtn').addEventListener('click', () => {
            const job = {
                dateRange: document.getElementById('dateRange').value,
                customer: document.getElementById('customer').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                quote: document.getElementById('quote').value,
                actual: document.getElementById('actual').value,
                sr: document.getElementById('sr').value,
                terms: document.getElementById('terms').value,
                expPaid: document.getElementById('expPaid').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                paid: document.getElementById('paid').checked
            };

            const editIdx = document.getElementById('editIndex').value;
            if (editIdx !== '') {
                data[currentYear][parseInt(editIdx)] = job;
            } else {
                if (!data[currentYear]) data[currentYear] = [];
                data[currentYear].push(job);
            }

            saveToStorage();
            bootstrap.Modal.getInstance(document.getElementById('jobModal')).hide();
            selectedRow = null;
            updateYearPage();
        });

        // === Delete Selected Job ===
        window.deleteSelected = () => {
            if (selectedRow === null || selectedRow === undefined) {
                alert('Please select a card to delete');
                return;
            }
            if (!confirm('Are you sure you want to delete this job?')) return;

            data[currentYear].splice(selectedRow, 1);
            saveToStorage();
            selectedRow = null;
            updateYearPage();
        };

        // === Export JSON (current year) ===
        window.exportJson = () => {
            const json = JSON.stringify(data[currentYear], null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `jobs-${currentYear}.json`;
            a.click();
            URL.revokeObjectURL(url);
        };

        // === Export All Years JSON ===
        window.exportAllYearsJson = () => {
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'jobs-all-years.json';
            a.click();
            URL.revokeObjectURL(url);
        };

        // === Import JSON ===
        window.importJson = (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);

                    // Check if it's all years or single year
                    if (Array.isArray(imported)) {
                        // Single year array
                        if (confirm(`Import ${imported.length} jobs into ${currentYear}? This will replace existing data.`)) {
                            data[currentYear] = imported;
                            saveToStorage();
                            updateYearPage();
                            alert('Import successful!');
                        }
                    } else if (typeof imported === 'object') {
                        // All years object
                        const years = Object.keys(imported);
                        if (confirm(`Import ${years.length} year(s)? This will replace existing data for those years.`)) {
                            years.forEach(y => {
                                data[y] = imported[y];
                            });
                            saveToStorage();
                            updateYearSelect();
                            updateYearPage();
                            alert('Import successful!');
                        }
                    }
                } catch (err) {
                    alert('Invalid JSON file: ' + err.message);
                }
            };
            reader.readAsText(file);
            event.target.value = ''; // Reset file input
        };

        // === Export PDF ===
        window.exportPdf = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');

            doc.setFontSize(16);
            doc.text(`JTI Jobs - ${currentYear}`, 14, 15);

            const jobs = data[currentYear] || [];
            const tableData = jobs.map(j => [
                j.dateRange || '',
                j.customer || '',
                j.city || '',
                j.state || '',
                j.quote ? `$${parseFloat(j.quote).toFixed(2)}` : '',
                j.actual ? `$${parseFloat(j.actual).toFixed(2)}` : '',
                j.sr || '',
                j.paid ? 'Yes' : 'No'
            ]);

            doc.autoTable({
                head: [['Date Range', 'Customer', 'City', 'State', 'Quote', 'Actual', 'SR#', 'Paid']],
                body: tableData,
                startY: 22,
                theme: 'grid',
                styles: { fontSize: 8 }
            });

            // Add summary
            const q = jobs.reduce((s,j) => s + (parseFloat(j.quote) || 0), 0);
            const g = jobs.reduce((s,j) => s + (parseFloat(j.actual) || 0), 0);
            const p = jobs.reduce((s,j) => j.paid ? s + (parseFloat(j.actual) || 0) : s, 0);

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(10);
            doc.text(`Quotes: $${q.toFixed(2)} | Gross: $${g.toFixed(2)} | Paid: $${p.toFixed(2)} | Unpaid: $${(g-p).toFixed(2)}`, 14, finalY);

            doc.save(`jobs-${currentYear}.pdf`);
        };

        // === Clear Storage ===
        let clearAction = null;

        window.confirmClearStorage = () => {
            clearAction = 'all';
            document.getElementById('clearModalBody').textContent = 'Are you sure you want to clear ALL local storage? This cannot be undone.';
            new bootstrap.Modal(document.getElementById('clearModal')).show();
        };

        window.confirmClearCurrentYear = () => {
            clearAction = 'year';
            document.getElementById('clearModalBody').textContent = `Are you sure you want to clear all data for ${currentYear}? This cannot be undone.`;
            new bootstrap.Modal(document.getElementById('clearModal')).show();
        };

        document.getElementById('confirmClearBtn').addEventListener('click', () => {
            if (clearAction === 'all') {
                localStorage.clear();
                data = { '2025': [] };
                currentYear = '2025';
            } else if (clearAction === 'year') {
                data[currentYear] = [];
            }
            saveToStorage();
            updateYearSelect();
            updateYearPage();
            bootstrap.Modal.getInstance(document.getElementById('clearModal')).hide();
            alert(clearAction === 'all' ? 'All local storage cleared!' : `${currentYear} data cleared!`);
        });

        // === Init ===
        try {
            loadFromStorage();
            updateYearSelect();
            updateYearPage();
            console.log('App initialized');
        } catch (e) { console.error(e); alert('Init error'); }
    </script>
</body>
</html>